<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>INSURANCE // RENEWAL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&family=Victor+Mono:ital,wght@1,100..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='favicon.svg') }}"
    />
  </head>
  <body>
    <!-- loader -->
    <div id="loader-overlay" class="loader-overlay">
      <div class="loader-content">
        <div class="spinner-text">
          > INITIALIZING SYSTEM...<br />
          > DOWNLOADING PREDICTIVE MODEL...<br />
          > PLEASE WAIT...
        </div>
        <div class="loading-bar"></div>
      </div>
    </div>

    <div class="ribbon">
      <span>
        >START PROJECT /// SOPHIE ROSERO MURIEL /// KAROL VANESSA VITONCO ///
        2025.11.22 /// MACHINE LEARNING /// INSURANCE_COMPANY.CSV /// JUPYTER
        NOTEBOOK /// PYTHON 3.12.3 /// EXPLORATORY DATA ANALYSIS /// DATA
        PROCESSING /// MODEL TRAINING/EVALUATION /// RANDOM FOREST /// KNN ///
        LOGISTIC REGRESSION /// DATA PROFILING /// SMOTE /// ONEHOTENCODER ///
        MINMAXSCALER /// FLASK ///
      </span>
    </div>

    <div class="grid-container">
      <aside class="panel-left">
        <div class="header">
          <h1>
            PREDICTOR<span class="plus">:</span><br /><span class="script-word"
              >Insurance</span
            ><br />REN<span class="plus">€</span>WAL
          </h1>
          <h2 class="project-subtitle">
            MACHINE LEARNING PROJECT:<br />
            <span style="color: white">// Sophie Muriel & Karol Vitonco</span>
          </h2>
        </div>
        <div class="manifesto">
          <p>
            Advanced evaluation with algorithms to predict insurance policy
            retention, based on payment patterns and demographic data. Enter the
            raw client values to obtain the probability of renewal in real time.
          </p>
          <br />
          <p style="color: white; font-weight: bold; font-size: 0.9em">
            // RANDOM FOREST PREDICTIVE MODEL.
          </p>
        </div>
        <div class="big-stat">25</div>
      </aside>
      <main class="panel-right">
        <form
          action="{{ url_for('predict')}}"
          method="post"
          id="predictionForm"
        >
          <div class="form-grid">
            <div class="input-group">
              <label>
                Percentage Premium Paid by Cash/Credit (#)
                <span class="error-badge"></span>
              </label>
              <input
                type="number"
                name="perc_premium_paid_by_cash_credit"
                placeholder="0.00 - 1.00"
                required
                min="0"
                max="1"
                step="0.001"
              />
            </div>
            <div class="input-group">
              <label>
                Annual Income ($)
                <span class="error-badge"></span>
              </label>
              <input
                type="number"
                name="income"
                placeholder="0 - 90.000.000"
                required
                min="0"
                max="90000000"
                step="10"
              />
            </div>
            <div class="input-group">
              <label>
                Underwriting Score (%)
                <span class="error-badge"></span>
              </label>
              <input
                type="number"
                name="application_underwriting_score"
                placeholder="0.00 - 100.00"
                required
                min="0"
                max="100"
                step="0.001"
              />
            </div>
            <div class="input-group">
              <label>
                Age in Years (#)
                <span class="error-badge"></span>
              </label>
              <input
                type="number"
                name="age_in_years"
                placeholder="0 - 103"
                required
                min="0"
                max="103"
                step="1"
              />
            </div>
            <div class="input-group">
              <label>
                Total Late Payments (#)
                <span class="error-badge"></span>
              </label>
              <input
                type="number"
                name="total_late_payments"
                placeholder="0 - 50"
                required
                min="0"
                max="50"
                step="1"
              />
            </div>
            <div class="input-group">
              <label>
                Late Payments History (0/1)
                <span class="error-badge"></span>
              </label>
              <input
                type="number"
                name="has_late_payments"
                placeholder="0 / 1"
                required
                min="0"
                max="1"
                step="1"
              />
            </div>
          </div>
          <div class="action-area">
            <div class="result-display">
              {% if prediction_text %}
              <div class="result-text">> RESULT:</div>
              <div class="result-value" style="color: var(--text-main)">
                {{ prediction_text|safe }}
              </div>
              {% else %}
              <div class="result-text">> STATUS:</div>
              <div class="result-value" style="color: #444">
                Waiting for Data...
              </div>
              {% endif %}
            </div>
            <button type="submit" class="btn-submit" id="submitBtn">
              Analyze <span style="font-size: 1.2em">→</span>
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      /* --- validation --- */
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("predictionForm");
        const inputs = form.querySelectorAll("input");
        const submitBtn = document.getElementById("submitBtn");

        function validateInput(input) {
          const group = input.parentElement;
          const badge = group.querySelector(".error-badge");
          let isValid = true;

          if (!input.checkValidity()) {
            isValid = false;
            group.classList.add("error-state");

            if (input.validity.valueMissing) {
              badge.textContent = "[REQUIRED]";
            } else if (input.validity.rangeOverflow) {
              badge.textContent = `[MAX: ${input.max}]`;
            } else if (input.validity.rangeUnderflow) {
              badge.textContent = `[MIN: ${input.min}]`;
            } else if (input.validity.stepMismatch) {
              badge.textContent = "[INCORRECT DECIMALS]";
            } else {
              badge.textContent = "[INVALID]";
            }
          } else {
            group.classList.remove("error-state");
            badge.textContent = "";
          }
          return isValid;
        }

        function checkAllInputs() {
          let allValid = true;
          inputs.forEach((input) => {
            if (!input.checkValidity()) allValid = false;
          });

          submitBtn.disabled = !allValid;
          if (!allValid) {
            submitBtn.style.opacity = "0.3";
            submitBtn.style.cursor = "not-allowed";
          } else {
            submitBtn.style.opacity = "1";
            submitBtn.style.cursor = "pointer";
          }
        }

        inputs.forEach((input) => {
          input.addEventListener("input", () => {
            validateInput(input);
            checkAllInputs();
          });
          input.addEventListener("blur", () => {
            validateInput(input);
            checkAllInputs();
          });
        });

        checkAllInputs();
      });

      /* --- loader --- */
      function hideLoader() {
        const loader = document.getElementById("loader-overlay");
        if (loader) {
          loader.style.opacity = "0";
          setTimeout(() => {
            loader.style.display = "none";
          }, 500);
        }
      }

      function checkServerStatus() {
        fetch("/status")
          .then((response) => response.json())
          .then((data) => {
            if (data.ready) {
              hideLoader();
            } else {
              setTimeout(checkServerStatus, 1000);
            }
          })
          .catch((error) => {
            console.error("Waiting for server...", error);
            setTimeout(checkServerStatus, 1000);
          });
      }

      const resultText = document.querySelector(".result-text");
      const hasResult = resultText && resultText.innerText.includes("RESULT");

      if (hasResult) {
        const loader = document.getElementById("loader-overlay");
        if (loader) loader.style.display = "none";
      } else {
        checkServerStatus();
      }
    </script>
  </body>
</html>
